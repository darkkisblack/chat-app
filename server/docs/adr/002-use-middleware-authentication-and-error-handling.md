# 003: Использование миддлваров для аутентификации и обработки ошибок

## Статус
Принято

## Контекст
Проект разрабатывается с использованием **Express.js** для серверной части, где необходима обработка запросов и управление безопасностью, а также правильная обработка ошибок.

- Для защиты маршрутов и обеспечения безопасности мы решили использовать **миддлвар для аутентификации** с использованием JWT токенов.
- Для более удобной работы с ошибками, решения для их перехвата и отправки понятных сообщений клиенту будет использоваться **миддлвар для обработки ошибок**.

## Решение
Для серверной части приложения решено использовать следующие миддлвары:
1. **Миддлвар для аутентификации**: Этот миддлвар будет проверять JWT токен в заголовках каждого запроса. Если токен недействителен или отсутствует, запрос будет отклонен с ошибкой 401.
   - **Преимущества**: Централизованная аутентификация для всех защищенных маршрутов, повышение безопасности.
   - **Реализация**: Миддлвар проверяет наличие токена в заголовке запроса и его корректность с использованием секретного ключа.

2. **Миддлвар для обработки ошибок**: Этот миддлвар перехватывает все необработанные ошибки и отправляет пользователю понятный ответ с соответствующим кодом ошибки и сообщением.
   - **Преимущества**: Удобная обработка ошибок в одном месте, централизованное логирование ошибок.
   - **Реализация**: Миддлвар перехватывает ошибки, логирует их (например, в файл или на внешний сервис), и отправляет детализированное сообщение в ответе, если приложение находится в режиме разработки, или общее сообщение для продакшн-версии.

### Пример реализации миддлваров:
```javascript
// middleware/authMiddleware.js
const jwt = require('jsonwebtoken');
const User = require('../models/userModel');

module.exports = (req, res, next) => {
  const token = req.header('Authorization')?.replace('Bearer ', '');

  if (!token) {
    return res.status(401).json({ message: 'Access denied. No token provided.' });
  }

  try {
    const decoded = jwt.verify(token, process.env.JWT_SECRET);
    req.user = decoded; // Добавляем пользователя в запрос
    next(); // Переходим к следующему миддлвару или маршруту
  } catch (err) {
    res.status(400).json({ message: 'Invalid token.' });
  }
};

// middleware/errorMiddleware.js
module.exports = (err, req, res, next) => {
  console.error(err.stack);  // Логируем ошибку для отладки
  res.status(err.status || 500).json({
    message: err.message || 'Internal Server Error',
    stack: process.env.NODE_ENV === 'development' ? err.stack : undefined,
  });
};
